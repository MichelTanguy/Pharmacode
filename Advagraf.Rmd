---
title: "PK Advagraf test"
author: "MICHEL Tanguy"
date: "08-07-2O25"
source: "Woillard et al., Br J Clin Pharmacol, 2011"
output: html_document
---

```{r}
##Loading of the packages
library(mrgsolve)
library(dplyr)
library(ggplot2)
library(pracma)
library(truncnorm)
library(tidyverse)
```

---

```{r}
##Model definition
code <- '
 [SET] end = 100, delta = 0.1

 [PARAM]
 
Ktr = 1.94   // taux de transit (h^-1)
Ka  = 1.94   // entrée vers central
CL  = 21.2   // clairance (L/h)
Q   = 79     // échange intercompartimental (L/h)
Vc  = 486    // volume central (L)
Vp  = 271    // volume périphérique (L)
// covariables
CYP3A5 = 0     // Génotype CYP3A5 (0 ou 1)
HCT    = 0.40  // Hématocrite (fraction, ex: 0.38)
STUDY  = 0     // Facteur d’étude (0 ou 1)

 [OMEGA] // Variabilité interindividuelle
0.0576  // Ktr (24%²)
0.0784  // CL  (28%²)
0.0961  // Vc  (31%²)
[CMT]
CENT
PERIPH
TRANS3
TRANS2
TRANS1
GUT

Je resteste au cas ou
 [SIGMA] // Erreur résiduelle 
 
0.0128   // erreur proportionnelle (11.3%²)
0.5041   // erreur additive (0.71²)

 [MAIN]
 
double CLcov = CL * (1 + 0.2 * CYP3A5) * (1 + 0.5 * (0.4 - HCT));  // Effet CYP3A5 (+20%) et HCT (inverse)
double Vccov = Vc * (1 + 0.1 * STUDY);  // Effet de l’étude (+10%)

double Ktr3 = Ktr * exp(ETA(1));        // ETA prend en compte IIV
double CLi  = CL * (1 + 0.2 * CYP3A5) * (1 + 0.5 * (0.4 - HCT)) * exp(ETA(2));  // IIV + covariables
double Vci  = Vc * (1 + 0.1 * STUDY) * exp(ETA(3));  // IIV + facteur étude

[ODE]
dxdt_GUT    = -Ktr3 * GUT;
dxdt_TRANS1 =  Ktr3 * GUT    - Ktr3 * TRANS1;
dxdt_TRANS2 =  Ktr3 * TRANS1 - Ktr3 * TRANS2;
dxdt_TRANS3 =  Ktr3 * TRANS2 - Ka * TRANS3;
dxdt_CENT   =  Ka * TRANS3 - (CLi/Vci)*CENT - Q/Vci*CENT + Q/Vp*PERIPH;
dxdt_PERIPH =  Q/Vci*CENT - Q/Vp*PERIPH;

[TABLE]
double CP_pred = CENT / Vci;
double CP = CP_pred * (1 + EPS(1)) + EPS(2);
capture CP;
'
#Compilation
mod <- mcode("advagraf_model", code)
```


```{r}
#Test cohorte de 20 patients
##Génération de la cohorte
set.seed(1234)

cohort_data <- expand.ev(
  ID = 1:200,
  amt = 4.5,
  time = 0,
  cmt = 1
) %>%
  mutate(
    HCT    = rtruncnorm(n(), a = 0.30, b = 0.50, mean = 0.40, sd = 0.04),   # HT (fraction)
    CYP3A5 = sample(0:1, size = n(), replace = TRUE, prob = c(0.7, 0.3)),   # 30% express
    STUDY  = sample(0:1, size = n(), replace = TRUE)                        # Centre
  )

## Simulation sur 24h
sim_cohort <- mod %>%
  data_set(cohort_data) %>%
  mrgsim(end = 24, delta = 0.1) %>%
  as_tibble()

##Graphes
ggplot(sim_cohort, aes(x = time, y = CP, color = factor(ID))) +
  geom_line(show.legend = FALSE, linewidth = 1) +
  labs(
    title = "PK simulée - Advagraf (200 patients avec COV)",
    x = "Temps (h)",
    y = "Concentration (ng/mL)"
  ) +
  theme_minimal()

```

